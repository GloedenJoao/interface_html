{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
{% macro column_field(field_name, label, selected, viz_types, col_class="col-md-6", disabled=False, help_text="") -%}
  <div class="{{ col_class }}" data-role="viz-field" data-viz="{{ viz_types }}">
    <label class="form-label" for="{{ field_name }}">{{ label }}</label>
    <select class="form-select" name="{{ field_name }}" id="{{ field_name }}" {% if disabled %}disabled{% endif %}>
      <option value="">Selecione...</option>
      {% for column in view_columns %}
      <option value="{{ column }}" {% if selected == column %}selected{% endif %}>{{ column }}</option>
      {% endfor %}
    </select>
    {% if help_text %}
    <div class="form-text">{{ help_text }}</div>
    {% endif %}
  </div>
{%- endmacro %}

<div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-4">
  <div>
    <h1 class="mb-1">Construção de Dashboards</h1>
    <p class="text-secondary mb-0">Combine views com gráficos interativos e aplique filtros dinâmicos às visualizações salvas.</p>
  </div>
  <div class="text-end">
    <span class="badge bg-light text-dark px-3 py-2">Tema escuro</span>
  </div>
</div>
<div class="row g-4">
  <div class="col-lg-5">
    <div class="card shadow-sm">
      <div class="card-header">Configurar visualização</div>
      <div class="card-body">
        {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
        {% endif %}
        {% if success %}
        <div class="alert alert-success">{{ success }}</div>
        {% endif %}
        <form method="post" id="dashboard-form">
          <input type="hidden" name="item_id" value="{{ edit_item.id if edit_item else '' }}">
          <div class="mb-3">
            <label class="form-label" for="viz_name">Nome da visualização</label>
            <input type="text" class="form-control" name="viz_name" id="viz_name" placeholder="ex.: Voos por dia" value="{{ viz_name_value }}">
          </div>
          <div class="mb-3">
            <label class="form-label" for="view_name">View base</label>
            <select class="form-select" name="view_name" id="view_name" onchange="this.form.submit()" required>
              <option value="">Selecione...</option>
              {% for view in views %}
              <option value="{{ view.name }}" {% if selected_view == view.name %}selected{% endif %}>{{ view.name }}</option>
              {% endfor %}
            </select>
          </div>
          {% if view_columns %}
          <div class="mb-3">
            <label class="form-label">Colunas disponíveis</label>
            <div class="d-flex flex-wrap gap-2">
              {% for column in view_columns %}
              <span class="badge bg-light text-dark px-3 py-2">{{ column }}</span>
              {% endfor %}
            </div>
          </div>
          {% else %}
          <p class="text-secondary">Selecione uma view para liberar a escolha de colunas.</p>
          {% endif %}
          <div class="mb-3">
            <label class="form-label" for="viz_type">Tipo</label>
            <select class="form-select" name="viz_type" id="viz_type" {% if not view_columns %}disabled{% endif %}>
              <option value="table" {% if viz_type_value == 'table' %}selected{% endif %}>Tabela</option>
              <option value="line" {% if viz_type_value == 'line' %}selected{% endif %}>Linha</option>
              <option value="bar" {% if viz_type_value == 'bar' %}selected{% endif %}>Barra</option>
              <option value="pie" {% if viz_type_value == 'pie' %}selected{% endif %}>Pizza</option>
              <option value="scatter" {% if viz_type_value == 'scatter' %}selected{% endif %}>Dispersão</option>
            </select>
          </div>
          <div class="row g-3" id="viz-fields">
            {{ column_field('x_column', 'Coluna X', columns_state['x'], 'line,bar,scatter', disabled=not view_columns) }}
            {{ column_field('y_column', 'Coluna Y', columns_state['y'], 'line,bar,scatter', disabled=not view_columns) }}
            {{ column_field('color_column', 'Cor dos pontos (opcional)', columns_state['color'], 'scatter', disabled=not view_columns, help_text='Defina uma coluna categórica para diferenciar os marcadores por cor.') }}
            {{ column_field('size_column', 'Tamanho (dispersão)', columns_state['size'], 'scatter', disabled=not view_columns) }}
            {{ column_field('text_column', 'Texto / Hover', columns_state['text'], 'scatter', disabled=not view_columns) }}
            {{ column_field('names_column', 'Rótulos (pizza)', columns_state['names'], 'pie', disabled=not view_columns) }}
            {{ column_field('value_column', 'Valores (pizza)', columns_state['values'], 'pie', disabled=not view_columns) }}
            <div class="col-12" data-role="viz-field" data-viz="table">
              <label class="form-label" for="table_columns">Colunas da tabela</label>
              <select class="form-select" id="table_columns" name="table_columns" multiple {% if not view_columns %}disabled{% endif %}>
                {% for column in view_columns %}
                <option value="{{ column }}" {% if column in selected_table_columns %}selected{% endif %}>{{ column }}</option>
                {% endfor %}
              </select>
              <div class="form-text">Selecione as colunas que deseja exibir na visualização em tabela.</div>
            </div>
          </div>
          <div class="mb-3 mt-3">
            <label class="form-label" for="filters">Filtros (um por linha)</label>
            <textarea class="form-control" name="filters" id="filters" rows="3" placeholder="coluna operador valor&#10;status = 'Scheduled'&#10;passageiros >= 150" {% if not view_columns %}disabled{% endif %}>{{ filters_value }}</textarea>
            <div class="form-text">Operadores aceitos: =, !=, &gt;, &lt;, &gt;=, &lt;=, contains.</div>
          </div>
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-outline-secondary" type="submit" name="action" value="preview" {% if not view_columns %}disabled{% endif %}>Pré-visualizar</button>
            <button class="btn btn-primary" type="submit" name="action" value="{% if edit_item %}update{% else %}add{% endif %}" {% if not view_columns %}disabled{% endif %}>
              {% if edit_item %}Salvar alterações{% else %}Adicionar ao dashboard{% endif %}
            </button>
            {% if edit_item %}
            <a class="btn btn-outline-danger" href="{{ url_for('dashboard') }}">Cancelar edição</a>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="col-lg-7">
    {% if preview %}
    <div class="card shadow-sm mb-4">
      <div class="card-header">Pré-visualização</div>
      <div class="card-body">
        {% if preview.type == 'table' %}
        <div class="table-responsive">
          {{ preview.table_html | safe }}
        </div>
        {% else %}
        <div id="preview-chart" style="height:360px;"></div>
        <script>
          Plotly.react('preview-chart', {{ preview.graph_json|safe }}, {displaylogo: false});
        </script>
        {% endif %}
      </div>
    </div>
    {% endif %}
    <div class="card shadow-sm">
      <div class="card-header">Dashboard</div>
      <div class="card-body">
        {% if dashboard_items %}
        {% for item in dashboard_items %}
        <div class="mb-5">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
              <h2 class="h5 mb-1">{{ item.name }}</h2>
              <div class="small text-muted">Fonte: {{ item.view_name }} • Tipo: {{ item.viz_type }}</div>
            </div>
            <div class="btn-group btn-group-sm">
              <a class="btn btn-outline-primary" href="{{ url_for('edit_dashboard_item', item_id=item.id) }}">Editar</a>
              <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filters-{{ item.id }}" aria-expanded="false" aria-controls="filters-{{ item.id }}">
                Filtros rápidos
              </button>
              <form method="post" action="{{ url_for('delete_dashboard_item', item_id=item.id) }}" class="d-inline" onsubmit="return confirm('Remover visualização {{ item.name }}?');">
                <button class="btn btn-outline-danger" type="submit">Remover</button>
              </form>
            </div>
          </div>
          {% if item.rendered.type == 'table' %}
          <div class="table-responsive mt-3">
            {{ item.rendered.table_html | safe }}
          </div>
          {% else %}
          <div id="chart-{{ item.id }}" style="height:360px;"></div>
          <script>
            Plotly.react('chart-{{ item.id }}', {{ item.rendered.graph_json|safe }}, {displaylogo: false});
          </script>
          {% endif %}
          {% if item.filters_text %}
          <div class="mt-3">
            <span class="badge bg-light text-dark">Filtros aplicados</span>
            <code class="ms-2">{{ item.filters_text.replace('\n', '; ') }}</code>
          </div>
          {% endif %}
          <div class="collapse mt-4" id="filters-{{ item.id }}">
            <div class="border rounded-4 p-3 bg-opacity-25" style="background: rgba(15, 25, 40, 0.75);">
              <form method="post" action="{{ url_for('dashboard') }}" data-filter-form>
                <input type="hidden" name="action" value="filter_saved">
                <input type="hidden" name="item_id" value="{{ item.id }}">
                {% set filter_ns = namespace(rows=[]) %}
                {% if item.filters_text %}
                  {% for line in item.filters_text.split('\n') %}
                    {% set tokens = line.split(' ', 2) %}
                    {% if tokens|length == 3 %}
                      {% set filter_ns.rows = filter_ns.rows + [{'column': tokens[0], 'operator': tokens[1], 'value': tokens[2]}] %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
                {% set filter_rows = filter_ns.rows if filter_ns.rows else [{'column': '', 'operator': '=', 'value': ''}] %}
                <div data-filter-rows>
                  {% for row in filter_rows %}
                  <div class="row g-3 align-items-end mb-2" data-filter-row>
                    <div class="col-md-4">
                      <label class="form-label">Coluna</label>
                      <select class="form-select" name="filter_column">
                        <option value="">Selecione...</option>
                        {% for column in dashboard_columns[item.id] %}
                        <option value="{{ column }}" {% if row.column == column %}selected{% endif %}>{{ column }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Operador</label>
                      {% set operator_value = row.operator if row.operator else '=' %}
                      <select class="form-select" name="filter_operator">
                        {% for op in ['=', '!=', '>', '<', '>=', '<=', 'contains'] %}
                        <option value="{{ op }}" {% if operator_value == op %}selected{% endif %}>{{ op }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Valor</label>
                      <input type="text" class="form-control" name="filter_value" value="{{ row.value }}" placeholder="Informe o valor">
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                      <button class="btn btn-sm btn-outline-danger w-100" type="button" data-remove-filter>&times;</button>
                    </div>
                  </div>
                  {% endfor %}
                </div>
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mt-3">
                  <button class="btn btn-sm btn-outline-secondary" type="button" data-add-filter>Adicionar filtro</button>
                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-danger" type="button" data-clear-filters>Limpar</button>
                    <button class="btn btn-sm btn-primary" type="submit">Aplicar filtros</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
        {% endfor %}
        {% else %}
        <p class="text-muted">Nenhuma visualização criada. Use o formulário ao lado para adicionar elementos ao dashboard.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
<script>
  (function () {
    const vizSelect = document.getElementById('viz_type');
    const fieldGroups = document.querySelectorAll('[data-role="viz-field"]');
    function toggleFields() {
      const type = vizSelect ? vizSelect.value : 'table';
      fieldGroups.forEach((group) => {
        const vizData = (group.dataset.viz || 'all').split(',').map((item) => item.trim());
        const shouldShow = vizData.includes('all') || vizData.includes(type) || vizData.some((value) => value === '');
        group.classList.toggle('d-none', !shouldShow);
      });
    }
    if (vizSelect) {
      vizSelect.addEventListener('change', toggleFields);
      toggleFields();
    }

    document.querySelectorAll('[data-filter-form]').forEach((form) => {
      const rowsContainer = form.querySelector('[data-filter-rows]');
      const addButton = form.querySelector('[data-add-filter]');
      const clearButton = form.querySelector('[data-clear-filters]');
      if (!rowsContainer || !addButton) {
        return;
      }
      function createRow() {
        const template = rowsContainer.querySelector('[data-filter-row]');
        const clone = template.cloneNode(true);
        clone.querySelectorAll('input, select').forEach((element) => {
          if (element.tagName === 'SELECT') {
            element.selectedIndex = 0;
          } else {
            element.value = '';
          }
        });
        return clone;
      }
      function refreshRemoveButtons() {
        const rows = rowsContainer.querySelectorAll('[data-filter-row]');
        rows.forEach((row, index) => {
          const removeButton = row.querySelector('[data-remove-filter]');
          if (removeButton) {
            removeButton.classList.toggle('invisible', rows.length === 1 || index === 0);
          }
        });
      }
      rowsContainer.addEventListener('click', (event) => {
        const target = event.target;
        if (target && target.matches('[data-remove-filter]')) {
          const row = target.closest('[data-filter-row]');
          if (row && rowsContainer.querySelectorAll('[data-filter-row]').length > 1) {
            row.remove();
            refreshRemoveButtons();
          }
        }
      });
      addButton.addEventListener('click', () => {
        const newRow = createRow();
        rowsContainer.appendChild(newRow);
        refreshRemoveButtons();
      });
      if (clearButton) {
        clearButton.addEventListener('click', () => {
          const rows = Array.from(rowsContainer.querySelectorAll('[data-filter-row]'));
          rows.slice(1).forEach((row) => row.remove());
          rowsContainer.querySelectorAll('input, select').forEach((element, index) => {
            if (element.tagName === 'SELECT') {
              element.selectedIndex = 0;
            } else {
              element.value = '';
            }
          });
          refreshRemoveButtons();
        });
      }
      refreshRemoveButtons();
    });
  })();
</script>
{% endblock %}
