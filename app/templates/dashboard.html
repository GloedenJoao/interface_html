{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-4">
  <div>
    <h1 class="mb-1">Construção de Dashboards</h1>
    <p class="text-secondary mb-0">Combine views com gráficos interativos e aplique filtros dinâmicos às visualizações salvas.</p>
  </div>
  <div class="text-end">
    <span class="badge bg-light text-dark px-3 py-2">Tema escuro</span>
  </div>
</div>
<div class="row g-4">
  <div class="col-lg-5">
    <div class="card shadow-sm">
      <div class="card-header">Configurar visualização</div>
      <div class="card-body">
        {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
        {% endif %}
        {% if success %}
        <div class="alert alert-success">{{ success }}</div>
        {% endif %}
        <form method="post" id="dashboard-form">
          <input type="hidden" name="item_id" value="{{ edit_item.id if edit_item else '' }}">
          <div class="mb-3">
            <label class="form-label" for="viz_name">Nome da visualização</label>
            <input type="text" class="form-control" name="viz_name" id="viz_name" placeholder="ex.: Voos por dia" value="{{ viz_name_value }}">
          </div>
          <div class="mb-3">
            <label class="form-label" for="view_name">View base</label>
            <select class="form-select" name="view_name" id="view_name" onchange="this.form.submit()" required>
              <option value="">Selecione...</option>
              {% for view in views %}
              <option value="{{ view.name }}" {% if selected_view == view.name %}selected{% endif %}>{{ view.name }}</option>
              {% endfor %}
            </select>
          </div>
          {% if view_columns %}
          <div class="mb-3">
            <label class="form-label">Colunas disponíveis</label>
            <div class="d-flex flex-wrap gap-2">
              {% for column in view_columns %}
              <span class="badge bg-light text-dark px-3 py-2">{{ column }}</span>
              {% endfor %}
            </div>
          </div>
          {% else %}
          <p class="text-secondary">Selecione uma view para liberar a escolha de colunas.</p>
          {% endif %}
          <div class="mb-3">
            <label class="form-label" for="viz_type">Tipo</label>
            <select class="form-select" name="viz_type" id="viz_type" {% if not view_columns %}disabled{% endif %}>
              <option value="table" {% if viz_type_value == 'table' %}selected{% endif %}>Tabela</option>
              <option value="pie" {% if viz_type_value == 'pie' %}selected{% endif %}>Pizza</option>
            </select>
          </div>
          <div class="row g-3" id="viz-fields">
            <div class="col-12" data-role="viz-field" data-viz="table">
              <label class="form-label" for="table_columns">Colunas da tabela</label>
              <select class="form-select" id="table_columns" name="table_columns" multiple {% if not view_columns %}disabled{% endif %}>
                {% for column in view_columns %}
                <option value="{{ column }}" {% if column in selected_table_columns %}selected{% endif %}>{{ column }}</option>
                {% endfor %}
              </select>
              <div class="form-text">Selecione as colunas que deseja exibir na visualização em tabela.</div>
            </div>
            <div class="col-md-6" data-role="viz-field" data-viz="pie">
              <label class="form-label" for="names_column">Coluna de rótulos</label>
              <select class="form-select" name="names_column" id="names_column" {% if not view_columns %}disabled{% endif %}>
                <option value="">Selecione...</option>
                {% for column in view_columns %}
                <option value="{{ column }}" {% if columns_state['names'] == column %}selected{% endif %}>{{ column }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6" data-role="viz-field" data-viz="pie">
              <label class="form-label" for="value_column">Coluna de valores</label>
              <select class="form-select" name="value_column" id="value_column" {% if not view_columns %}disabled{% endif %}>
                <option value="">Selecione...</option>
                {% for column in view_columns %}
                <option value="{{ column }}" {% if columns_state['values'] == column %}selected{% endif %}>{{ column }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-outline-secondary" type="submit" name="action" value="preview" {% if not view_columns %}disabled{% endif %}>Pré-visualizar</button>
            <button class="btn btn-primary" type="submit" name="action" value="{% if edit_item %}update{% else %}add{% endif %}" {% if not view_columns %}disabled{% endif %}>
              {% if edit_item %}Salvar alterações{% else %}Adicionar ao dashboard{% endif %}
            </button>
            {% if edit_item %}
            <a class="btn btn-outline-danger" href="{{ url_for('dashboard') }}">Cancelar edição</a>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="col-lg-7">
    {% if preview %}
    <div class="card shadow-sm mb-4">
      <div class="card-header">Pré-visualização</div>
      <div class="card-body">
        {% if preview.type == 'table' %}
        <div class="table-responsive">
          {{ preview.table_html | safe }}
        </div>
        {% else %}
        <div id="preview-chart" style="height:360px;"></div>
        <script>
          Plotly.react('preview-chart', {{ preview.graph_json|safe }}, {displaylogo: false});
        </script>
        {% endif %}
      </div>
    </div>
    {% endif %}
    <div class="card shadow-sm">
      <div class="card-header">Dashboard</div>
      <div class="card-body">
        {% if dashboard_items %}
        {% for item in dashboard_items %}
        <div class="mb-5">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
              <h2 class="h5 mb-1">{{ item.name }}</h2>
              <div class="small text-muted">Fonte: {{ item.view_name }} • Tipo: {{ item.viz_type }}</div>
            </div>
            <div class="btn-group btn-group-sm">
              <a class="btn btn-outline-primary" href="{{ url_for('edit_dashboard_item', item_id=item.id) }}">Editar</a>
              <form method="post" action="{{ url_for('delete_dashboard_item', item_id=item.id) }}" class="d-inline" onsubmit="return confirm('Remover visualização {{ item.name }}?');">
                <button class="btn btn-outline-danger" type="submit">Remover</button>
              </form>
            </div>
          </div>
          {% if item.rendered.type == 'table' %}
          <div class="table-responsive mt-3">
            {{ item.rendered.table_html | safe }}
          </div>
          {% else %}
          <div id="chart-{{ item.id }}" style="height:360px;"></div>
          <script>
            Plotly.react('chart-{{ item.id }}', {{ item.rendered.graph_json|safe }}, {displaylogo: false});
          </script>
          {% endif %}
        </div>
        {% endfor %}
        {% else %}
        <p class="text-muted">Nenhuma visualização criada. Use o formulário ao lado para adicionar elementos ao dashboard.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
<script>
  (function () {
    const vizSelect = document.getElementById('viz_type');
    const fieldGroups = document.querySelectorAll('[data-role="viz-field"]');
    function toggleFields() {
      const type = vizSelect ? vizSelect.value : 'table';
      fieldGroups.forEach((group) => {
        const vizData = (group.dataset.viz || 'all').split(',').map((item) => item.trim());
        const shouldShow = vizData.includes('all') || vizData.includes(type) || vizData.some((value) => value === '');
        group.classList.toggle('d-none', !shouldShow);
      });
    }
    if (vizSelect) {
      vizSelect.addEventListener('change', toggleFields);
      toggleFields();
    }

  })();
</script>
{% endblock %}
