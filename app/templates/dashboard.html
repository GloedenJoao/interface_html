{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-4">
  <div>
    <h1 class="mb-1">Construção de Dashboards</h1>
    <p class="text-secondary mb-0">Combine views com gráficos interativos e aplique filtros dinâmicos às visualizações salvas.</p>
  </div>
  <div class="text-end">
    <span class="badge bg-light text-dark px-3 py-2">Tema escuro</span>
  </div>
</div>
<div class="row g-4">
  <div class="col-lg-5">
    <div class="card shadow-sm">
      <div class="card-header">Configurar visualização</div>
      <div class="card-body">
        {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
        {% endif %}
        {% if success %}
        <div class="alert alert-success">{{ success }}</div>
        {% endif %}
        <form method="post" id="dashboard-form">
          <input type="hidden" name="item_id" value="{{ edit_item.id if edit_item else '' }}">
          <div class="mb-3">
            <label class="form-label" for="viz_name">Nome da visualização</label>
            <input type="text" class="form-control" name="viz_name" id="viz_name" placeholder="ex.: Voos por dia" value="{{ viz_name_value }}">
          </div>
          <div class="mb-3">
            <label class="form-label" for="view_name">View base</label>
            <select class="form-select" name="view_name" id="view_name" onchange="this.form.submit()" required>
              <option value="">Selecione...</option>
              {% for view in views %}
              <option value="{{ view.name }}" {% if selected_view == view.name %}selected{% endif %}>{{ view.name }}</option>
              {% endfor %}
            </select>
          </div>
          {% if view_columns %}
          <div class="mb-3">
            <label class="form-label">Colunas disponíveis</label>
            <div class="d-flex flex-wrap gap-2">
              {% for column in view_columns %}
              <span class="badge bg-light text-dark px-3 py-2">{{ column }}</span>
              {% endfor %}
            </div>
          </div>
          {% else %}
          <p class="text-secondary">Selecione uma view para liberar a escolha de colunas.</p>
          {% endif %}
          <div class="mb-3">
            <label class="form-label" for="viz_type">Tipo</label>
            <select class="form-select" name="viz_type" id="viz_type" {% if not view_columns %}disabled{% endif %}>
              <option value="table" {% if viz_type_value == 'table' %}selected{% endif %}>Tabela</option>
              <option value="pie" {% if viz_type_value == 'pie' %}selected{% endif %}>Pizza</option>
            </select>
          </div>
          <div class="row g-3" id="viz-fields">
            <div class="col-12" data-role="viz-field" data-viz="table">
              <label class="form-label" for="table_columns">Colunas da tabela</label>
              <select class="form-select" id="table_columns" name="table_columns" multiple {% if not view_columns %}disabled{% endif %}>
                {% for column in view_columns %}
                <option value="{{ column }}" {% if column in selected_table_columns %}selected{% endif %}>{{ column }}</option>
                {% endfor %}
              </select>
              <div class="form-text">Selecione as colunas que deseja exibir na visualização em tabela.</div>
            </div>
            <div class="col-md-6" data-role="viz-field" data-viz="pie">
              <label class="form-label" for="names_column">Coluna de rótulos</label>
              <select class="form-select" name="names_column" id="names_column" {% if not view_columns %}disabled{% endif %}>
                <option value="">Selecione...</option>
                {% for column in view_columns %}
                <option value="{{ column }}" {% if columns_state['names'] == column %}selected{% endif %}>{{ column }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6" data-role="viz-field" data-viz="pie">
              <label class="form-label" for="value_column">Coluna de valores</label>
              <select class="form-select" name="value_column" id="value_column" {% if not view_columns %}disabled{% endif %}>
                <option value="">Selecione...</option>
                {% for column in view_columns %}
                <option value="{{ column }}" {% if columns_state['values'] == column %}selected{% endif %}>{{ column }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="mb-3 mt-3">
            <label class="form-label" for="filter_columns">Colunas adicionais para filtros rápidos</label>
            <select class="form-select" id="filter_columns" name="filter_columns" multiple {% if not view_columns %}disabled{% endif %}>
              {% for column in view_columns %}
              <option value="{{ column }}" {% if column in selected_additional_filter_columns %}selected{% endif %}>{{ column }}</option>
              {% endfor %}
            </select>
            <div class="form-text">Opcional: escolha colunas extras que aparecerão na área de filtros rápidos.</div>
          </div>
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-outline-secondary" type="submit" name="action" value="preview" {% if not view_columns %}disabled{% endif %}>Pré-visualizar</button>
            <button class="btn btn-primary" type="submit" name="action" value="{% if edit_item %}update{% else %}add{% endif %}" {% if not view_columns %}disabled{% endif %}>
              {% if edit_item %}Salvar alterações{% else %}Adicionar ao dashboard{% endif %}
            </button>
            {% if edit_item %}
            <a class="btn btn-outline-danger" href="{{ url_for('dashboard') }}">Cancelar edição</a>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="col-lg-7">
    {% if preview %}
    <div class="card shadow-sm mb-4">
      <div class="card-header">Pré-visualização</div>
      <div class="card-body">
        {% if preview.type == 'table' %}
        <div class="table-responsive">
          {{ preview.table_html | safe }}
        </div>
        {% else %}
        <div id="preview-chart" style="height:360px;"></div>
        <script>
          Plotly.react('preview-chart', {{ preview.graph_json|safe }}, {displaylogo: false});
        </script>
        {% endif %}
      </div>
    </div>
    {% endif %}
    <div class="card shadow-sm">
      <div class="card-header">Dashboard</div>
      <div class="card-body">
        {% if dashboard_items %}
        {% for item in dashboard_items %}
        <div class="mb-5">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
              <h2 class="h5 mb-1">{{ item.name }}</h2>
              <div class="small text-muted">Fonte: {{ item.view_name }} • Tipo: {{ item.viz_type }}</div>
            </div>
            <div class="btn-group btn-group-sm">
              <a class="btn btn-outline-primary" href="{{ url_for('edit_dashboard_item', item_id=item.id) }}">Editar</a>
              {% set metadata = dashboard_filter_metadata[item.id] %}
              <button class="btn btn-outline-secondary d-flex align-items-center gap-2" type="button" data-bs-toggle="collapse" data-bs-target="#filters-{{ item.id }}" aria-expanded="false" aria-controls="filters-{{ item.id }}">
                <span>Filtros rápidos</span>
                {% if metadata.used %}
                <span class="badge bg-light text-dark text-wrap">{{ metadata.used | join(', ') }}</span>
                {% endif %}
              </button>
              <form method="post" action="{{ url_for('delete_dashboard_item', item_id=item.id) }}" class="d-inline" onsubmit="return confirm('Remover visualização {{ item.name }}?');">
                <button class="btn btn-outline-danger" type="submit">Remover</button>
              </form>
            </div>
          </div>
          {% if item.rendered.type == 'table' %}
          <div class="table-responsive mt-3">
            {{ item.rendered.table_html | safe }}
          </div>
          {% else %}
          <div id="chart-{{ item.id }}" style="height:360px;"></div>
          <script>
            Plotly.react('chart-{{ item.id }}', {{ item.rendered.graph_json|safe }}, {displaylogo: false});
          </script>
          {% endif %}
          {% if item.filters_text %}
          <div class="mt-3">
            <span class="badge bg-light text-dark">Filtros aplicados</span>
            <code class="ms-2">{{ item.filters_text.replace('\n', '; ') }}</code>
          </div>
          {% endif %}
          <div class="collapse mt-4" id="filters-{{ item.id }}">
            <div class="border rounded-4 p-3 bg-opacity-25" style="background: rgba(15, 25, 40, 0.75);">
              <form method="post" action="{{ url_for('dashboard') }}" data-filter-form data-values="{{ metadata.values | tojson | e }}" data-form-id="{{ item.id }}">
                <input type="hidden" name="action" value="filter_saved">
                <input type="hidden" name="item_id" value="{{ item.id }}">
                {% set filter_ns = namespace(rows=[]) %}
                {% if item.filters_text %}
                  {% for line in item.filters_text.split('\n') %}
                    {% set tokens = line.split(' ', 2) %}
                    {% if tokens|length == 3 %}
                      {% set filter_ns.rows = filter_ns.rows + [{'column': tokens[0], 'operator': tokens[1], 'value': tokens[2]}] %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
                {% set filter_rows = filter_ns.rows if filter_ns.rows else [{'column': '', 'operator': '=', 'value': ''}] %}
                <div data-filter-rows>
                  {% for row in filter_rows %}
                  <div class="row g-3 align-items-end mb-2" data-filter-row>
                    <div class="col-md-4">
                      <label class="form-label">Coluna</label>
                      <select class="form-select" name="filter_column">
                        <option value="">Selecione...</option>
                        {% for column in metadata.allowed %}
                        <option value="{{ column }}" {% if row.column == column %}selected{% endif %}>{{ column }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Operador</label>
                      {% set operator_value = row.operator if row.operator else '=' %}
                      <select class="form-select" name="filter_operator">
                        {% for op in ['=', '!=', '>', '<', '>=', '<=', 'contains'] %}
                        <option value="{{ op }}" {% if operator_value == op %}selected{% endif %}>{{ op }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Valores sugeridos</label>
                      <div class="d-flex flex-wrap gap-2" data-value-options>
                        <span class="text-muted small">Selecione uma coluna para ver os valores.</span>
                      </div>
                      <input type="hidden" name="filter_value" value="{{ row.value }}" data-filter-value>
                      <div class="form-text small text-muted">Escolha um ou mais valores para preencher o filtro.</div>
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                      <button class="btn btn-sm btn-outline-danger w-100" type="button" data-remove-filter>&times;</button>
                    </div>
                  </div>
                  {% endfor %}
                </div>
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mt-3">
                  <button class="btn btn-sm btn-outline-secondary" type="button" data-add-filter>Adicionar filtro</button>
                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-danger" type="button" data-clear-filters>Limpar</button>
                    <button class="btn btn-sm btn-primary" type="submit">Aplicar filtros</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
        {% endfor %}
        {% else %}
        <p class="text-muted">Nenhuma visualização criada. Use o formulário ao lado para adicionar elementos ao dashboard.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
<script>
  (function () {
    const vizSelect = document.getElementById('viz_type');
    const fieldGroups = document.querySelectorAll('[data-role="viz-field"]');
    function toggleFields() {
      const type = vizSelect ? vizSelect.value : 'table';
      fieldGroups.forEach((group) => {
        const vizData = (group.dataset.viz || 'all').split(',').map((item) => item.trim());
        const shouldShow = vizData.includes('all') || vizData.includes(type) || vizData.some((value) => value === '');
        group.classList.toggle('d-none', !shouldShow);
      });
    }
    if (vizSelect) {
      vizSelect.addEventListener('change', toggleFields);
      toggleFields();
    }

    document.querySelectorAll('[data-filter-form]').forEach((form) => {
      const rowsContainer = form.querySelector('[data-filter-rows]');
      const addButton = form.querySelector('[data-add-filter]');
      const clearButton = form.querySelector('[data-clear-filters]');
      if (!rowsContainer || !addButton) {
        return;
      }

      let valueMap = {};
      try {
        valueMap = JSON.parse(form.dataset.values || '{}');
      } catch (error) {
        valueMap = {};
      }

      const controllers = new WeakMap();

      function parseHiddenValues(rawValue) {
        if (!rawValue) {
          return [];
        }
        return rawValue
          .split('||')
          .map((item) => item.trim())
          .filter((item) => item.length > 0)
          .map((item) => item.replace(/^['"]+|['"]+$/g, ''));
      }

      function updateHiddenFromSelection(row) {
        const data = controllers.get(row);
        if (!data) {
          return;
        }
        const selected = Array.from(row.querySelectorAll('[data-value-option]:checked')).map((element) => element.value.trim());
        data.hiddenInput.value = selected.join('||');
      }

      function renderValueOptions(row, preserveSelection) {
        const data = controllers.get(row);
        if (!data) {
          return;
        }
        const column = data.columnSelect.value;
        const container = data.valuesContainer;
        const existingSelection = preserveSelection ? parseHiddenValues(data.hiddenInput.value) : [];
        if (!preserveSelection) {
          data.hiddenInput.value = '';
        } else {
          data.hiddenInput.value = existingSelection.join('||');
        }
        container.innerHTML = '';
        if (!column) {
          const message = document.createElement('span');
          message.className = 'text-muted small';
          message.textContent = 'Selecione uma coluna para ver os valores.';
          container.appendChild(message);
          return;
        }
        const availableValues = Array.isArray(valueMap[column]) ? valueMap[column] : [];
        if (!availableValues.length) {
          const message = document.createElement('span');
          message.className = 'text-muted small';
          message.textContent = 'Nenhum valor sugerido disponível para esta coluna.';
          container.appendChild(message);
          if (existingSelection.length) {
            const current = document.createElement('div');
            current.className = 'mt-2 small text-warning';
            current.textContent = `Valor atual: ${existingSelection.join(', ')}`;
            container.appendChild(current);
          }
          return;
        }

        const normalizedOptions = availableValues.map((option) => String(option));
        const availableSet = new Set(normalizedOptions);
        const selectedValues = existingSelection.filter((value) => availableSet.has(value));
        const selectedLookup = new Set(selectedValues);
        const missingValues = existingSelection.filter((value) => !availableSet.has(value));

        normalizedOptions.forEach((optionValue) => {
          const label = document.createElement('label');
          label.className = 'form-check form-check-inline me-2 mb-2';
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'form-check-input me-2';
          checkbox.value = optionValue;
          checkbox.dataset.valueOption = 'true';
          checkbox.checked = selectedLookup.has(optionValue);
          label.appendChild(checkbox);
          const text = document.createElement('span');
          text.textContent = optionValue === '' ? '(vazio)' : optionValue;
          label.appendChild(text);
          container.appendChild(label);
        });

        data.hiddenInput.value = [...selectedValues].join('||');

        if (missingValues.length) {
          const info = document.createElement('div');
          info.className = 'mt-2 small text-warning';
          info.textContent = `Valor atual fora da lista sugerida: ${missingValues.join(', ')}`;
          container.appendChild(info);
          data.hiddenInput.value = [...selectedValues, ...missingValues].join('||');
        }
      }

      function initializeRow(row) {
        if (controllers.has(row)) {
          renderValueOptions(row, true);
          return;
        }
        const columnSelect = row.querySelector('select[name="filter_column"]');
        const operatorSelect = row.querySelector('select[name="filter_operator"]');
        const hiddenInput = row.querySelector('input[name="filter_value"][data-filter-value]');
        const valuesContainer = row.querySelector('[data-value-options]');
        if (!columnSelect || !hiddenInput || !valuesContainer) {
          return;
        }
        controllers.set(row, {
          columnSelect,
          operatorSelect,
          hiddenInput,
          valuesContainer,
        });

        columnSelect.addEventListener('change', () => {
          hiddenInput.value = '';
          renderValueOptions(row, false);
        });

        row.addEventListener('change', (event) => {
          const target = event.target;
          if (target && target.matches('[data-value-option]')) {
            updateHiddenFromSelection(row);
          }
        });

        renderValueOptions(row, true);
      }

      function createRow() {
        const template = rowsContainer.querySelector('[data-filter-row]');
        const clone = template.cloneNode(true);
        clone.querySelectorAll('input, select').forEach((element) => {
          if (element.tagName === 'SELECT') {
            element.selectedIndex = 0;
          } else {
            element.value = '';
          }
        });
        initializeRow(clone);
        return clone;
      }

      function refreshRemoveButtons() {
        const rows = rowsContainer.querySelectorAll('[data-filter-row]');
        rows.forEach((row, index) => {
          const removeButton = row.querySelector('[data-remove-filter]');
          if (removeButton) {
            removeButton.classList.toggle('invisible', rows.length === 1 || index === 0);
          }
        });
      }

      rowsContainer.addEventListener('click', (event) => {
        const target = event.target;
        if (target && target.matches('[data-remove-filter]')) {
          const row = target.closest('[data-filter-row]');
          if (row && rowsContainer.querySelectorAll('[data-filter-row]').length > 1) {
            row.remove();
            refreshRemoveButtons();
          }
        }
      });

      addButton.addEventListener('click', () => {
        const newRow = createRow();
        rowsContainer.appendChild(newRow);
        refreshRemoveButtons();
      });

      if (clearButton) {
        clearButton.addEventListener('click', () => {
          const rows = Array.from(rowsContainer.querySelectorAll('[data-filter-row]'));
          rows.slice(1).forEach((row) => row.remove());
          rowsContainer.querySelectorAll('select').forEach((element) => {
            element.selectedIndex = 0;
          });
          rowsContainer.querySelectorAll('input[data-filter-value]').forEach((element) => {
            element.value = '';
          });
          rowsContainer.querySelectorAll('[data-filter-row]').forEach((row) => {
            renderValueOptions(row, false);
          });
          refreshRemoveButtons();
        });
      }

      form.addEventListener('submit', () => {
        rowsContainer.querySelectorAll('[data-filter-row]').forEach((row) => {
          initializeRow(row);
          const data = controllers.get(row);
          if (!data) {
            return;
          }
          const selectedValues = parseHiddenValues(data.hiddenInput.value);
          if (!selectedValues.length) {
            return;
          }
          data.hiddenInput.value = selectedValues[0];
          const columnValue = data.columnSelect.value;
          const operatorValue = data.operatorSelect ? data.operatorSelect.value : '';
          if (!columnValue || !operatorValue) {
            return;
          }
          for (let index = 1; index < selectedValues.length; index += 1) {
            const extraColumn = document.createElement('input');
            extraColumn.type = 'hidden';
            extraColumn.name = 'filter_column';
            extraColumn.value = columnValue;
            form.appendChild(extraColumn);

            const extraOperator = document.createElement('input');
            extraOperator.type = 'hidden';
            extraOperator.name = 'filter_operator';
            extraOperator.value = operatorValue;
            form.appendChild(extraOperator);

            const extraValue = document.createElement('input');
            extraValue.type = 'hidden';
            extraValue.name = 'filter_value';
            extraValue.value = selectedValues[index];
            form.appendChild(extraValue);
          }
        });
      });

      rowsContainer.querySelectorAll('[data-filter-row]').forEach((row) => initializeRow(row));
      refreshRemoveButtons();
    });
  })();
</script>
{% endblock %}
